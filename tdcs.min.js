/*
 * TDCS (Traffic Data Capture Script) for Marketo Forms
 * @author Sergei Lebedev
 * @version v1.0.2 2025-07-03
 * @copyright Â© 2025 Sergei Lebedev
 * @license MIT: This license must appear with all reproductions of this software.
 *
 */

// Configuration variables - Marketo API field names mapping
const UTM_FIELDS = {
	'utm_source': 'mkt_utm_source',
	'utm_medium': 'mkt_utm_medium',
	'utm_campaign': 'mkt_utm_campaign',
	'utm_content': 'mkt_utm_content',
	'utm_term': 'mkt_utm_term',
	'utm_adgroup': 'mkt_utm_adgroup',
	'utm_keyword': 'mkt_utm_keyword'
};

// Add configuration for primary domain and secondary domains
const PRIMARY_DOMAIN = 'yourdomain.com';
const SECONDARY_DOMAINS = ['domain2.com', 'domain3.com'];

/**************** DO NOT EDIT BELOW THIS LINE ****************/

const SE_LIST=new Map([["www.google","google"],[".google.co","google"],["www.bing","bing"],[".bing.com","bing"],["www.yahoo","yahoo"],["search.yahoo","yahoo"],["yahoo.cn","yahoo"],["www.yandex","yandex"],["yandex.ru","yandex"],["ya.ru","yandex"],["yandex.com","yandex"],["www.ecosia.org","ecosia"],["duckduckgo.com","duckduckgo"],["android.googlequicksearchbox","google"],["baidu.com","baidu"],["search.aol.com","aol"],["www.ask.com","ask"],["search.brave.com","brave"],["www.startpage.com","startpage"],["www.qwant.com","qwant"],["searx.me","searx"],["www.dogpile.com","dogpile"],["www.wolframalpha.com","wolframalpha"],["www.archive.org","internetarchive"],["go.mail.ru","mailru"],["www.naver.com","naver"],["www.daum.net","daum"],["www.seznam.cz","seznam"],["www.rediff.com","rediff"],["search.sify.com","sify"],["www.indiatimes.com","indiatimes"],["www.khoj.com","khoj"],["www.bhanvad.com","bhanvad"],["www.guruji.com","guruji"],["www.123musiq.com","123musiq"]]),SOCIAL_LIST=new Map([["linkedin.com","linkedin"],["com.linkedin.android","linkedin"],["facebook.com","facebook"],["twitter.com","twitter"],["x.com","x"],["instagram.com","instagram"],["pinterest.com","pinterest"],["reddit.com","reddit"],["t.co","twitter"],["lnkd.in","linkedin"],["fb.me","facebook"],["bit.ly","bitly"],["youtu.be","youtube"],["youtube.com","youtube"],["tumblr.com","tumblr"],["tiktok.com","tiktok"],["medium.com","medium"],["quora.com","quora"]]),CLIDS_LIST=new Map([["msclkid","bing"],["fbclid","facebook"],["yclid","yahoo"],["gclid","google"],["cq_gclid","google"],["dclid","google"],["twclid","twitter"],["li_fat_id","linkedin"],["ttclid","tiktok"],["pt_id","pinterest"],["wbraid","google"],["gbraid","google"],["igshid","instagram"],["mc_eid","mailchimp"],["hsa_cam","hubspot"],["ad_id","snapchat"],["rtd_id","reddit"],["vero_id","vero"],["otm_campaign","outbrain"],["cid","adobe"],["s_cid","adobe"],["sclid","sharechat"],["zclid","zomato"],["fclid","flipkart"],["pclid","paytm"],["mclid","makemytrip"],["oclid","ola"],["uclid","uber"],["jclid","jio"],["hclid","hotstar"],["gpclid","googleplay"],["aclid","amazonin"]]),SEARCH_TERMS=["q","query","search","text","p","wd"],IS_DEBUG_MODE="#debug"===window.location.hash;function debug(e,t){IS_DEBUG_MODE&&(void 0===t?console.log(`[TDCS Debug] ${e}`):console.log(`[TDCS Debug] ${e}`,t))}const domainCache=new Map;function getRootDomain(e){if(domainCache.has(e))return domainCache.get(e);const t=e.split("."),r=t.length>2?t.slice(-2).join("."):e;return domainCache.set(e,r),r}function isDomainOrSubdomain(e,t){return e===t||e.endsWith("."+t)}function isSecondaryDomain(e){return SECONDARY_DOMAINS.includes(e)}function createCookie(e,t,r,o){try{let i="";if(r){const e=new Date;e.setTime(e.getTime()+24*r*60*60*1e3),i="; expires="+e.toUTCString()}const a=o?"; domain="+o:"";document.cookie=e+"="+t+i+a+"; path=/;",debug(`Cookie created: ${e} on domain: ${o||"current domain"}`)}catch(t){debug(`Error creating cookie ${e}:`,t)}}function readCookie(e){try{const t=e+"=",r=document.cookie.split(";");for(let o=0;o<r.length;o++){let i=r[o];for(;" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return debug(`Cookie read: ${e}`),i.substring(t.length,i.length)}return debug(`Cookie not found: ${e}`),null}catch(t){return debug(`Error reading cookie ${e}:`,t),null}}function getParameterCaseInsensitive(e,t){return new URLSearchParams(e.search.toLowerCase()).get(t.toLowerCase())}function extractSearchQuery(e){try{const t=new URLSearchParams(e.substring(e.indexOf("?")));debug("Search params:",Object.fromEntries(t));for(const e of SEARCH_TERMS){const r=t.get(e);if(r)return decodeURIComponent(r)}}catch(e){debug("Error in extractSearchQuery:",e)}return null}const isValidValue=e=>e&&"string"==typeof e&&""!==e.trim()&&"undefined"!==e&&"null"!==e&&"(not set)"!==e;debug("Starting main tracking logic");const referrer=document.referrer,paramsString=window.location.search,searchParams=new URLSearchParams(paramsString);let utm_campaign=null,utm_source=null,utm_medium=null,utm_term=null,utm_content=null,utm_adgroup=null,utm_keyword=null,clid=null,visitorAttributes={},isInternalReferrer=!1;const eventId=Math.floor(Math.random()*Math.pow(10,9)),currentTimestamp=Math.floor(Date.now()/1e3),currentRootDomain=getRootDomain(window.location.hostname);debug(`Current root domain: ${currentRootDomain}`);let referrerRootDomain="";if(referrer){referrerRootDomain=getRootDomain(new URL(referrer).hostname),isInternalReferrer=currentRootDomain===referrerRootDomain||currentRootDomain===PRIMARY_DOMAIN&&isSecondaryDomain(referrerRootDomain)||isSecondaryDomain(currentRootDomain)&&(referrerRootDomain===PRIMARY_DOMAIN||isSecondaryDomain(referrerRootDomain)),debug(`Referrer: ${referrer}, Referrer root domain: ${referrerRootDomain}, Is internal: ${isInternalReferrer}`)}const initialVisitId=readCookie("initialVisitId"),isFirstVisit=!initialVisitId;debug(`Is first visit: ${isFirstVisit}`);const tdcs=sessionStorage.getItem("tdcs");if(tdcs)visitorAttributes=JSON.parse(atob(tdcs)),debug("Using existing traffic data from session storage");else{function getParameterCaseInsensitive(e,t){let r=e.get(t);if(null!==r)return r;const o=t.toLowerCase();for(const[t,r]of e.entries())if(t.toLowerCase()===o)return r;return null}if(debug("No existing traffic data, collecting new data"),utm_source=getParameterCaseInsensitive(searchParams,"utm_source"),utm_medium=getParameterCaseInsensitive(searchParams,"utm_medium"),utm_campaign=getParameterCaseInsensitive(searchParams,"utm_campaign")||getParameterCaseInsensitive(searchParams,"ga_campaign")||getParameterCaseInsensitive(searchParams,"cq_cmp"),utm_term=getParameterCaseInsensitive(searchParams,"utm_term"),utm_content=getParameterCaseInsensitive(searchParams,"utm_content"),utm_adgroup=getParameterCaseInsensitive(searchParams,"utm_adgroup")||getParameterCaseInsensitive(searchParams,"utm_ad_group"),utm_keyword=getParameterCaseInsensitive(searchParams,"utm_keyword"),utm_source=isValidValue(utm_source)?utm_source:null,utm_medium=isValidValue(utm_medium)?utm_medium:null,utm_campaign=isValidValue(utm_campaign)?utm_campaign:null,utm_term=isValidValue(utm_term)?utm_term:null,utm_content=isValidValue(utm_content)?utm_content:null,utm_adgroup=isValidValue(utm_adgroup)?utm_adgroup:null,utm_keyword=isValidValue(utm_keyword)?utm_keyword:null,debug(`UTM parameters: utm_source=${utm_source}, utm_medium=${utm_medium}, utm_campaign=${utm_campaign}, utm_term=${utm_term}, utm_content=${utm_content}, utm_adgroup=${utm_adgroup}, utm_keyword=${utm_keyword}`),!utm_source&&!utm_medium)for(const[t,r]of CLIDS_LIST)if(searchParams.has(t)){utm_source=r,utm_medium="cpc",clid=`${t}:${searchParams.get(t)}`,debug(`Click ID found: ${clid}, set utm_source: ${utm_source}, utm_medium: ${utm_medium}`);break}if(!utm_source&&!utm_medium)if(referrer&&!isInternalReferrer){for(const[o,i]of SE_LIST)if(referrer.includes(o)){utm_source=i,utm_medium="organic",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:utm_campaign||"(not set)";try{const a=extractSearchQuery(referrer);a&&(utm_keyword=a)}catch(n){debug("Error extracting search keyword:",n)}debug(`Search engine referrer found: ${o}, set utm_source: ${utm_source}, utm_medium: ${utm_medium}, utm_campaign: ${utm_campaign}, utm_keyword: ${utm_keyword}`);break}if(!utm_source){const m=new URL(referrer).hostname.toLowerCase();for(const[u,s]of SOCIAL_LIST)if(isDomainOrSubdomain(m,u)){utm_source=s,utm_medium="social",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:utm_campaign||"(not set)",debug(`Social network referrer found: ${u}, set utm_source: ${utm_source}, utm_medium: ${utm_medium}, utm_campaign: ${utm_campaign}`);break}}utm_source||(utm_source=referrerRootDomain||referrer,utm_medium="referral",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:utm_campaign||"(not set)",debug(`Unknown referrer, set utm_source: ${utm_source}, utm_medium: ${utm_medium}, utm_campaign: ${utm_campaign}`))}else referrer&&!isInternalReferrer||(utm_source="direct",utm_medium="none",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:"(not set)",debug("No referrer or internal referrer, set as direct"));utm_source&&utm_medium&&!utm_campaign&&(utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:"(not set)",debug('Set utm_campaign to "(not set)" as utm_source and utm_medium are present but utm_campaign is empty after all checks'));const e=readCookie("_ga");visitorAttributes={landing_page:document.location.href,utm_source:utm_source,utm_medium:utm_medium,utm_campaign:utm_campaign,utm_term:utm_term,utm_content:utm_content,utm_adgroup:utm_adgroup,utm_keyword:utm_keyword,clid:clid,query_params:paramsString,session_referrer:referrer,is_first_visit:isFirstVisit,event_id:eventId,initial_visit_id:initialVisitId||`${eventId}.${currentTimestamp}`,ga_cookie:e},debug("Visitor attributes compiled",visitorAttributes);try{sessionStorage.setItem("tdcs",btoa(JSON.stringify(visitorAttributes))),debug("Visitor attributes stored in session storage")}catch(c){debug("Error storing TDCS data in session storage:",c)}}initialVisitId||(createCookie("initialVisitId",`${eventId}.${currentTimestamp}`,730,currentRootDomain),debug("Initial visit cookie created")),"undefined"!=typeof MktoForms2?(debug("MktoForms2 detected, setting up form integration"),MktoForms2.whenReady(function(e){debug(`Marketo form ready, ID: ${e.getId()}`);const t={},r=e=>""===e||null==e;for(const[e,o]of Object.entries(UTM_FIELDS)){const i=visitorAttributes[e];t[o]=r(i)?"NULL":i,debug(`Mapping ${e} to ${o}: ${t[o]}`)}t.tdcs=btoa(JSON.stringify(visitorAttributes))||"",e.addHiddenFields(t),debug("Hidden fields added to Marketo form");const o=e.getValues;e.onSubmit(function(e){e.getValues=function(){const e=o(),t=new URL(document.location.href),r=new URL(t.origin+t.pathname);return t.searchParams.forEach((e,t)=>{t.toLowerCase().startsWith("utm_")||r.searchParams.append(t,e)}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term","utm_adgroup","utm_keyword"].forEach(e=>{const o=visitorAttributes[e]||getParameterCaseInsensitive(t,e);o&&r.searchParams.append(e,o)}),r.hash=t.hash,Object.defineProperty(e,"_mktoReferrer",{value:r.toString(),enumerable:!0}),debug("Modified _mktoReferrer value:",e._mktoReferrer),e}})})):debug("MktoForms2 not detected");
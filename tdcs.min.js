/*
 * TDCS (Traffic Data Capture Script) for Marketo Forms
 * @author Sergei Lebedev
 * @version v1.0.0 2024-09-26
 * @copyright Â© 2024 Sergei Lebedev
 * @license MIT: This license must appear with all reproductions of this software.
 *
 */

// Configuration variables - Marketo API field names mapping
const UTM_FIELDS = {
	'utm_source': 'mkt_utm_source',
	'utm_medium': 'mkt_utm_medium',
	'utm_campaign': 'mkt_utm_campaign',
	'utm_content': 'mkt_utm_content',
	'utm_term': 'mkt_utm_term',
	'utm_adgroup': 'mkt_utm_adgroup',
	'utm_keyword': 'mkt_utm_keyword'
};

// Add configuration for primary domain and secondary domains
const PRIMARY_DOMAIN = 'yourdomain.com';
const SECONDARY_DOMAINS = ['domain2.com', 'domain3.com'];

/**************** DO NOT EDIT BELOW THIS LINE ****************/

const SE_LIST=new Map([["www.google","google"],[".google.co","google"],["www.bing","bing"],[".bing.com","bing"],["www.yahoo","yahoo"],["search.yahoo","yahoo"],["yahoo.cn","yahoo"],["www.yandex","yandex"],["yandex.ru","yandex"],["ya.ru","yandex"],["yandex.com","yandex"],["www.ecosia.org","ecosia"],["duckduckgo.com","duckduckgo"],["android.googlequicksearchbox","google"],["baidu.com","baidu"],["search.aol.com","aol"],["www.ask.com","ask"],["search.brave.com","brave"],["www.startpage.com","startpage"],["www.qwant.com","qwant"],["searx.me","searx"],["www.dogpile.com","dogpile"],["www.wolframalpha.com","wolframalpha"],["www.archive.org","internetarchive"],["go.mail.ru","mailru"],["www.naver.com","naver"],["www.daum.net","daum"],["www.seznam.cz","seznam"],["www.rediff.com","rediff"],["search.sify.com","sify"],["www.indiatimes.com","indiatimes"],["www.khoj.com","khoj"],["www.bhanvad.com","bhanvad"],["www.guruji.com","guruji"],["www.123musiq.com","123musiq"]]),SOCIAL_LIST=new Map([["linkedin.com","linkedin"],["com.linkedin.android","linkedin"],["facebook.com","facebook"],["twitter.com","twitter"],["x.com","x"],["instagram.com","instagram"],["pinterest.com","pinterest"],["reddit.com","reddit"],["t.co","twitter"],["lnkd.in","linkedin"],["fb.me","facebook"],["bit.ly","bitly"],["youtu.be","youtube"],["youtube.com","youtube"],["tumblr.com","tumblr"],["tiktok.com","tiktok"],["medium.com","medium"],["quora.com","quora"]]),CLIDS_LIST=new Map([["msclkid","bing"],["fbclid","facebook"],["yclid","yahoo"],["gclid","google"],["cq_gclid","google"],["dclid","google"],["twclid","twitter"],["li_fat_id","linkedin"],["ttclid","tiktok"],["pt_id","pinterest"],["wbraid","google"],["gbraid","google"],["igshid","instagram"],["mc_eid","mailchimp"],["hsa_cam","hubspot"],["ad_id","snapchat"],["rtd_id","reddit"],["vero_id","vero"],["otm_campaign","outbrain"],["cid","adobe"],["s_cid","adobe"],["sclid","sharechat"],["zclid","zomato"],["fclid","flipkart"],["pclid","paytm"],["mclid","makemytrip"],["oclid","ola"],["uclid","uber"],["jclid","jio"],["hclid","hotstar"],["gpclid","googleplay"],["aclid","amazonin"]]);function debug(e,t){"#debug"===window.location.hash&&(void 0===t?console.log(`[TDCS Debug] ${e}`):console.log(`[TDCS Debug] ${e}`,t))}function getRootDomain(e){const t=e.split(".");return t.length>2?t.slice(-2).join("."):e}function isDomainOrSubdomain(e,t){return e===t||e.endsWith("."+t)}function isSecondaryDomain(e){return SECONDARY_DOMAINS.includes(e)}function createCookie(e,t,r,o){let i="";if(r){const e=new Date;e.setTime(e.getTime()+24*r*60*60*1e3),i="; expires="+e.toUTCString()}const a=o?"; domain="+o:"";document.cookie=e+"="+t+i+a+"; path=/;",debug(`Cookie created: ${e} on domain: ${o||"current domain"}`)}function readCookie(e){const t=e+"=",r=document.cookie.split(";");for(let o=0;o<r.length;o++){let i=r[o];for(;" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return debug(`Cookie read: ${e}`),i.substring(t.length,i.length)}return debug(`Cookie not found: ${e}`),null}function getParameterCaseInsensitive(e,t){return new URLSearchParams(e.search.toLowerCase()).get(t.toLowerCase())}function extractSearchQuery(e){try{const t=new URLSearchParams(e.substring(e.indexOf("?")));debug("Search params:",Object.fromEntries(t));const r=["q","query","search","text","p","wd"];for(const e of r){const r=t.get(e);if(r)return decodeURIComponent(r)}}catch(e){debug("Error in extractSearchQuery:",e)}return null}debug("Starting main tracking logic");const referrer=document.referrer,paramsString=window.location.search,searchParams=new URLSearchParams(paramsString);let utm_campaign=null,utm_source=null,utm_medium=null,utm_term=null,utm_content=null,utm_adgroup=null,utm_keyword=null,clid=null,visitorAttributes={},isInternalReferrer=!1;const eventId=Math.floor(Math.random()*Math.pow(10,9)),currentTimestamp=Math.floor(Date.now()/1e3),currentRootDomain=getRootDomain(window.location.hostname);debug(`Current root domain: ${currentRootDomain}`);let referrerRootDomain="";if(referrer){referrerRootDomain=getRootDomain(new URL(referrer).hostname),isInternalReferrer=currentRootDomain===referrerRootDomain||currentRootDomain===PRIMARY_DOMAIN&&isSecondaryDomain(referrerRootDomain)||isSecondaryDomain(currentRootDomain)&&(referrerRootDomain===PRIMARY_DOMAIN||isSecondaryDomain(referrerRootDomain)),debug(`Referrer: ${referrer}, Referrer root domain: ${referrerRootDomain}, Is internal: ${isInternalReferrer}`)}const initialVisitId=readCookie("initialVisitId"),isFirstVisit=!initialVisitId;debug(`Is first visit: ${isFirstVisit}`);const tdcs=sessionStorage.getItem("tdcs");if(tdcs)visitorAttributes=JSON.parse(atob(tdcs)),debug("Using existing traffic data from session storage");else{debug("No existing traffic data, collecting new data");for(const[e,t]of searchParams.entries()){switch(e.toLowerCase()){case"utm_source":utm_source=t||null;break;case"utm_medium":utm_medium=t||null;break;case"utm_campaign":case"ga_campaign":case"cq_cmp":utm_campaign=t||null;break;case"utm_term":utm_term=t||null;break;case"utm_content":utm_content=t||null;break;case"utm_adgroup":case"utm_ad_group":utm_adgroup=t||null;break;case"utm_keyword":utm_keyword=t||null}}if(debug(`UTM parameters: utm_source=${utm_source}, utm_medium=${utm_medium}, utm_campaign=${utm_campaign}, utm_term=${utm_term}, utm_content=${utm_content}, utm_adgroup=${utm_adgroup}, utm_keyword=${utm_keyword}`),!utm_source&&!utm_medium)for(const[e,t]of CLIDS_LIST)if(searchParams.has(e)){utm_source=t,utm_medium="cpc",clid=`${e}:${searchParams.get(e)}`,debug(`Click ID found: ${clid}, set utm_source: ${utm_source}, utm_medium: ${utm_medium}`);break}if(!utm_source&&!utm_medium)if(referrer&&!isInternalReferrer){for(const[e,t]of SE_LIST)if(referrer.includes(e)){utm_source=t,utm_medium="organic",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:utm_campaign||"(not set)";try{const e=extractSearchQuery(referrer);e&&(utm_keyword=e)}catch(e){debug("Error extracting search keyword:",e)}debug(`Search engine referrer found: ${e}, set utm_source: ${utm_source}, utm_medium: ${utm_medium}, utm_campaign: ${utm_campaign}, utm_keyword: ${utm_keyword}`);break}if(!utm_source){const e=new URL(referrer).hostname.toLowerCase();for(const[t,r]of SOCIAL_LIST)if(isDomainOrSubdomain(e,t)){utm_source=r,utm_medium="social",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:utm_campaign||"(not set)",debug(`Social network referrer found: ${t}, set utm_source: ${utm_source}, utm_medium: ${utm_medium}, utm_campaign: ${utm_campaign}`);break}}utm_source||(utm_source=referrerRootDomain||referrer,utm_medium="referral",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:utm_campaign||"(not set)",debug(`Unknown referrer, set utm_source: ${utm_source}, utm_medium: ${utm_medium}, utm_campaign: ${utm_campaign}`))}else referrer&&!isInternalReferrer||(utm_source="direct",utm_medium="none",utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:"(not set)",debug("No referrer or internal referrer, set as direct"));utm_source&&utm_medium&&!utm_campaign&&(utm_campaign=isSecondaryDomain(currentRootDomain)?currentRootDomain:"(not set)",debug('Set utm_campaign to "(not set)" as utm_source and utm_medium are present but utm_campaign is empty after all checks'));const e=readCookie("_ga");visitorAttributes={landing_page:document.location.href,utm_source:utm_source,utm_medium:utm_medium,utm_campaign:utm_campaign,utm_term:utm_term,utm_content:utm_content,utm_adgroup:utm_adgroup,utm_keyword:utm_keyword,clid:clid,query_params:paramsString,session_referrer:referrer,is_first_visit:isFirstVisit,event_id:eventId,initial_visit_id:initialVisitId||`${eventId}.${currentTimestamp}`,ga_cookie:e},debug("Visitor attributes compiled",visitorAttributes),sessionStorage.setItem("tdcs",btoa(JSON.stringify(visitorAttributes))),debug("Visitor attributes stored in session storage")}initialVisitId||(createCookie("initialVisitId",`${eventId}.${currentTimestamp}`,730,currentRootDomain),debug("Initial visit cookie created")),"undefined"!=typeof MktoForms2?(debug("MktoForms2 detected, setting up form integration"),MktoForms2.whenReady((function(e){debug(`Marketo form ready, ID: ${e.getId()}`);const t={},r=e=>""===e||null==e;for(const[e,o]of Object.entries(UTM_FIELDS)){const i=visitorAttributes[e];t[o]=r(i)?"NULL":i,debug(`Mapping ${e} to ${o}: ${t[o]}`)}t.tdcs=btoa(JSON.stringify(visitorAttributes))||"",e.addHiddenFields(t),debug("Hidden fields added to Marketo form");const o=e.getValues;e.onSubmit((function(e){e.getValues=function(){const e=o(),t=new URL(document.location.href),r=new URL(t.origin+t.pathname);return t.searchParams.forEach(((e,t)=>{t.toLowerCase().startsWith("utm_")||r.searchParams.append(t,e)})),["utm_source","utm_medium","utm_campaign","utm_content","utm_term","utm_adgroup","utm_keyword"].forEach((e=>{const o=visitorAttributes[e]||getParameterCaseInsensitive(t,e);o&&r.searchParams.append(e,o)})),r.hash=t.hash,Object.defineProperty(e,"_mktoReferrer",{value:r.toString(),enumerable:!0}),debug("Modified _mktoReferrer value:",e._mktoReferrer),e}}))}))):debug("MktoForms2 not detected");